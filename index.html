<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tom's Road Trip Planner</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://accounts.google.com https://ssl.gstatic.com; script-src-elem 'self' https://accounts.google.com https://ssl.gstatic.com; style-src 'self' https://fonts.googleapis.com https://accounts.google.com; style-src-elem 'self' https://fonts.googleapis.com https://accounts.google.com; font-src 'self' https://fonts.gstatic.com https://accounts.google.com data:; connect-src 'self' https://www.googleapis.com; frame-src https://accounts.google.com; img-src 'self' data: https://lh3.googleusercontent.com;">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eüöó%3C/text%3E%3C/svg%3E">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Caveat:wght@600&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>ROAD TRIP</h1>
      <div class="tagline" id="subtitle" title="Click to edit">Plan Your Perfect Journey</div>
      <div id="userIndicator" class="user-indicator hidden">
        <img id="userAvatar" class="user-avatar" src="" alt="">
        <span id="userName"></span>
      </div>
    </header>

    <!-- Map View Button -->
    <div class="map-menu">
      <button class="map-btn" id="mapBtn" title="View on Map">
        üó∫Ô∏è
      </button>
    </div>

    <!-- Hamburger Menu -->
    <div class="hamburger-menu">
      <button class="hamburger-btn" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <div class="menu-overlay" id="menuOverlay"></div>
    <div class="menu-panel">
      <!-- User Profile Section -->
      <div class="user-profile-section">
        <div id="loggedOutView">
          <h3 class="account-heading">Account</h3>
          <div id="googleButtonContainer"></div>
        </div>

        <div id="loggedInView" class="hidden">
          <h3 class="account-heading">Account</h3>
          <div class="user-profile-card">
            <img id="menuUserAvatar" class="user-profile-avatar" src="" alt="">
            <div class="user-profile-name" id="menuUserName"></div>
            <div class="user-profile-email" id="menuUserEmail"></div>
          </div>
          <button class="btn-danger full-width" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="menu-section">
        <h3>Add Activity</h3>
        <button class="btn-primary" id="newActivityBtn">+ New Activity</button>
      </div>

      <div class="menu-section">
        <h3>Filter</h3>
        <label for="filterDate" class="filter-label">Select Date:</label>
        <input type="date" id="filterDate" class="filter-input">
        <button class="btn-secondary" id="clearFilterBtn">Show All Days</button>
      </div>

      <div class="menu-section">
        <h3>Tools</h3>
        
        <!-- Google Drive Sync Section -->
        <div class="gdrive-sync-section hidden" id="gdriveSyncSection">
          <div class="gdrive-sync-title">
            üìÅ Google Drive Sync
          </div>
          <div id="gdriveStatus">
            <span class="gdrive-status disconnected">Not Connected</span>
          </div>
          <div class="gdrive-input-group" id="gdriveSetup">
            <input 
              type="text" 
              id="gdriveFileId" 
              placeholder="Enter Google Drive File ID"
              value="1lxkUvkts9T0fmOPFrFihsPlC_IEOPq5M"
            >
            <div class="gdrive-button-group">
              <button class="btn-secondary" id="connectGDriveBtn">Connect</button>
            </div>
          </div>
          <div class="gdrive-button-group gdrive-actions hidden" id="gdriveActions">
            <button class="btn-primary" id="syncGDriveBtn">
              üîÑ Refresh
            </button>
            <button class="btn-secondary" id="saveGDriveBtn">
              üíæ Save to Drive
            </button>
            <button class="btn-danger btn-small" id="disconnectGDriveBtn">
              Disconnect
            </button>
          </div>
        </div>
        
        <button class="btn-secondary" id="exportBtn">Export Trip Data</button>
        <button class="btn-secondary" id="importBtn">Import from JSON</button>
        <button class="btn-danger" id="clearAllBtn">Clear All Activities</button>
      </div>
    </div>

    <div id="timeline" class="timeline"></div>
  </div>

  <!-- Add/Edit Activity Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <button class="modal-close modal-close-btn">&times;</button>
      <h2 id="modalTitle">Add Activity</h2>
      <div id="activityForm">
        <div class="form-group">
          <label for="activityType">Activity Type</label>
          <select id="activityType" required>
            <option value="driving">üöó Driving</option>
            <option value="eating">üçΩÔ∏è Eating</option>
            <option value="sleeping">üõèÔ∏è Sleeping</option>
            <option value="other">üéØ Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="activityName">Activity Name</label>
          <input type="text" id="activityName" placeholder="e.g., Lunch at Joe's Diner" required>
        </div>

        <div class="form-group">
          <label for="address">Address</label>
          <input type="text" id="address" placeholder="e.g., 123 Main St, Springfield, IL" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="startDateTime">Start Date & Time</label>
            <input type="datetime-local" id="startDateTime" required>
          </div>

          <div class="form-group">
            <label for="duration">Duration (hours)</label>
            <input type="number" id="duration" step="0.25" min="0.25" placeholder="e.g., 1.5" required>
          </div>
        </div>

        <div class="form-group">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" placeholder="Any special notes or details..."></textarea>
        </div>

        <div class="button-group">
          <button type="button" class="btn-primary" id="saveActivityBtn">Save Activity</button>
          <button type="button" class="btn-secondary" id="cancelActivityBtn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <button class="modal-close modal-close-btn">&times;</button>
      <h2>Import Trip Data</h2>
      <div class="form-group">
        <label for="importJSON">Paste JSON Data</label>
        <textarea id="importJSON" class="json-export" placeholder='{"activities": [...]}'></textarea>
      </div>
      <div class="button-group">
        <button class="btn-primary" id="importDataBtn">Import</button>
        <button class="btn-secondary" id="cancelImportBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <button class="modal-close modal-close-btn">&times;</button>
      <h2>Export Trip Data</h2>
      <div class="form-group">
        <label for="exportJSON">Copy this JSON</label>
        <textarea id="exportJSON" class="json-export" readonly></textarea>
      </div>
      <div class="button-group">
        <button class="btn-primary" id="copyExportBtn">Copy to Clipboard</button>
        <button class="btn-secondary" id="downloadExportBtn">Download File</button>
        <button class="btn-secondary" id="closeExportBtn">Close</button>
      </div>
    </div>
  </div>

  <script src="main.js" defer></script>
      document.getElementById('gdriveStatus').innerHTML = '<span class="gdrive-status disconnected">Not Connected</span>';
      
      showNotification('Disconnected from Google Drive', 'info');
    }

    // Sync from Google Drive (Import)
    async function syncFromGoogleDrive() {
      if (!googleAccessToken || !googleDriveFileId) {
        showNotification('Not connected to Google Drive', 'error');
        return;
      }
      
      const refreshBtn = event?.target;
      
      try {
        // Show loading indicator
        if (refreshBtn) {
          refreshBtn.innerHTML = '<span class="refresh-indicator">üîÑ</span> Refreshing...';
          refreshBtn.disabled = true;
        }
        
        const response = await fetch(
          `https://www.googleapis.com/drive/v3/files/${googleDriveFileId}?alt=media`,
          {
            headers: {
              'Authorization': `Bearer ${googleAccessToken}`
            }
          }
        );
        
        if (!response.ok) {
          if (response.status === 401) {
            // Token expired, request new one
            googleAccessToken = null;
            localStorage.removeItem('googleAccessToken');
            showNotification('Session expired. Please reconnect.', 'error');
            requestGoogleDriveAccess();
            return;
          } else if (response.status === 403) {
            showNotification('Access denied. Make sure the file is shared with you.', 'error');
            return;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.activities && Array.isArray(data.activities)) {
          activities = data.activities;
          subtitle = data.subtitle || 'Plan Your Perfect Journey';
          document.getElementById('subtitle').textContent = subtitle;
          activities.sort((a, b) => new Date(a.startDateTime) - new Date(b.startDateTime));
          saveData();
          renderTimeline();
          showNotification('‚úì Synced from Google Drive', 'success');
        } else {
          throw new Error('Invalid JSON format');
        }
      } catch (error) {
        console.error('Error syncing from Google Drive:', error);
        showNotification('Failed to sync from Google Drive: ' + error.message, 'error');
      } finally {
        // Reset button
        if (refreshBtn) {
          refreshBtn.innerHTML = 'üîÑ Refresh';
          refreshBtn.disabled = false;
        }
      }
    }

    // Save to Google Drive (Export)
    async function saveToGoogleDrive() {
      if (!googleAccessToken || !googleDriveFileId) {
        showNotification('Not connected to Google Drive', 'error');
        return;
      }
      
      const saveBtn = event?.target;
      
      try {
        const data = {
          subtitle: subtitle,
          activities: activities
        };
        
        if (saveBtn) {
          saveBtn.innerHTML = 'üíæ Saving...';
          saveBtn.disabled = true;
        }
        
        const response = await fetch(
          `https://www.googleapis.com/upload/drive/v3/files/${googleDriveFileId}?uploadType=media`,
          {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${googleAccessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data, null, 2)
          }
        );
        
        if (!response.ok) {
          if (response.status === 401) {
            googleAccessToken = null;
            localStorage.removeItem('googleAccessToken');
            showNotification('Session expired. Please reconnect.', 'error');
            requestGoogleDriveAccess();
            return;
          } else if (response.status === 403) {
            showNotification('Access denied. You may not have edit permissions.', 'error');
            return;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        showNotification('‚úì Saved to Google Drive', 'success');
      } catch (error) {
        console.error('Error saving to Google Drive:', error);
        showNotification('Failed to save to Google Drive: ' + error.message, 'error');
      } finally {
        if (saveBtn) {
          saveBtn.innerHTML = 'üíæ Save to Drive';
          saveBtn.disabled = false;
        }
      }
    }

    // Update UI based on user state
    function updateUIForUser() {
      const loggedInView = document.getElementById('loggedInView');
      const loggedOutView = document.getElementById('loggedOutView');
      const userIndicator = document.getElementById('userIndicator');
      const gdriveSyncSection = document.getElementById('gdriveSyncSection');
      
      if (currentUser) {
        // Show logged in view
        loggedInView.style.display = 'block';
        loggedOutView.style.display = 'none';
        
        // Update menu profile
        document.getElementById('menuUserAvatar').src = currentUser.picture;
        document.getElementById('menuUserName').textContent = currentUser.name;
        document.getElementById('menuUserEmail').textContent = currentUser.email;
        
        // Update header indicator
        userIndicator.style.display = 'flex';
        document.getElementById('userAvatar').src = currentUser.picture;
        document.getElementById('userName').textContent = currentUser.name;
        
        // Always show Google Drive section when logged in
        gdriveSyncSection.style.display = 'block';
        
        // If file ID is saved, show connected state
        if (googleDriveFileId) {
          document.getElementById('gdriveSetup').style.display = 'none';
          document.getElementById('gdriveActions').style.display = 'flex';
          document.getElementById('gdriveStatus').innerHTML = '<span class="gdrive-status connected">‚úì Connected</span>';
        }
      } else {
        // Show logged out view
        loggedInView.style.display = 'none';
        loggedOutView.style.display = 'block';
        userIndicator.style.display = 'none';
        gdriveSyncSection.style.display = 'none';
      }
    }

    // load/save and menu toggle logic moved to `main.js` to comply with CSP and avoid inline scripts
    // See `main.js` for `initAppState`, `toggleMenu`, and storage helpers


    // Subtitle editor moved to `main.js` (uses a class-based editor to comply with CSP)
    // See `main.js` for the enhanced implementation

    // Calculate end time based on start time and duration
    function calculateEndTime(startDateTime, durationHours) {
      const start = new Date(startDateTime);
      const end = new Date(start.getTime() + durationHours * 60 * 60 * 1000);
      // Return in local datetime format (YYYY-MM-DDTHH:mm)
      const year = end.getFullYear();
      const month = String(end.getMonth() + 1).padStart(2, '0');
      const day = String(end.getDate()).padStart(2, '0');
      const hours = String(end.getHours()).padStart(2, '0');
      const minutes = String(end.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Format date for display - Fixed to use local date string parsing
    function formatDate(dateString) {
      // Parse as local date to avoid timezone issues
      const [year, month, day] = dateString.split('-');
      const date = new Date(year, month - 1, day);
      return date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }

    // Format time for display
    function formatTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
    }

    // Get Google Maps directions URL
    function getDirectionsUrl(address) {
      const encodedAddress = encodeURIComponent(address);
      return `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
    }

    // Open map view with all activities
    function openMapView() {
      let activitiesToMap = activities;
      
      // If filtered, only show filtered activities
      if (filterDate) {
        activitiesToMap = activities.filter(a => a.startDateTime.startsWith(filterDate));
      }
      
      if (activitiesToMap.length === 0) {
        showNotification('No activities to show on map', 'error');
        return;
      }
      
      // Build Google Maps URL with directions
      // Google Maps supports up to 10 waypoints, so we'll use the first 10 activities
      const maxWaypoints = 9; // origin + 9 waypoints + destination = 11 total stops
      const limitedActivities = activitiesToMap.slice(0, maxWaypoints + 1);
      
      let mapUrl = 'https://www.google.com/maps/dir/?api=1';
      
      // Set origin (first activity)
      const origin = encodeURIComponent(limitedActivities[0].address);
      mapUrl += `&origin=${origin}`;
      
      // Set destination (last activity in our limited set)
      const destination = encodeURIComponent(limitedActivities[limitedActivities.length - 1].address);
      mapUrl += `&destination=${destination}`;
      
      // Set waypoints (middle activities)
      if (limitedActivities.length > 2) {
        const waypoints = limitedActivities.slice(1, -1).map(a => encodeURIComponent(a.address)).join('|');
        mapUrl += `&waypoints=${waypoints}`;
      }
      
      // Open in new tab
      window.open(mapUrl, '_blank');
      
      // Show notification if we had to limit activities
      if (activitiesToMap.length > maxWaypoints + 1) {
        showNotification(`Showing first ${maxWaypoints + 1} activities on map (Google Maps limit)`, 'info');
      }
    }

    // Open add modal
    function openAddModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Add Activity';
      // Reset all form fields
      document.getElementById('activityType').value = 'driving';
      document.getElementById('activityName').value = '';
      document.getElementById('address').value = '';
      document.getElementById('duration').value = '';
      document.getElementById('notes').value = '';
      
      // Set start time to last activity's end time, or current time if no activities
      let defaultStartTime;
      if (activities.length > 0) {
        // Get the last activity (already sorted)
        const lastActivity = activities[activities.length - 1];
        defaultStartTime = lastActivity.endDateTime;
      } else {
        // No activities yet, use current time rounded to nearest 15 minutes
        const now = new Date();
        now.setMinutes(Math.round(now.getMinutes() / 15) * 15);
        now.setSeconds(0);
        now.setMilliseconds(0);
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        defaultStartTime = `${year}-${month}-${day}T${hours}:${minutes}`;
      }
      
      document.getElementById('startDateTime').value = defaultStartTime;
      document.getElementById('activityModal').classList.add('active');
    }

    // Open edit modal
    function openEditModal(id) {
      editingId = id;
      const activity = activities.find(a => a.id === id);
      
      document.getElementById('modalTitle').textContent = 'Edit Activity';
      document.getElementById('activityType').value = activity.type;
      document.getElementById('activityName').value = activity.name;
      document.getElementById('address').value = activity.address;
      document.getElementById('startDateTime').value = activity.startDateTime;
      document.getElementById('duration').value = activity.duration;
      document.getElementById('notes').value = activity.notes || '';
      
      document.getElementById('activityModal').classList.add('active');
    }

    // Close modal
    function closeModal() {
      document.getElementById('activityModal').classList.remove('active');
      editingId = null;
    }

    // Save activity - FIXED
    function saveActivity() {
      const type = document.getElementById('activityType').value;
      const name = document.getElementById('activityName').value;
      const address = document.getElementById('address').value;
      const startDateTime = document.getElementById('startDateTime').value;
      const duration = parseFloat(document.getElementById('duration').value);
      const notes = document.getElementById('notes').value;
      
      // Validate required fields
      if (!name || !address || !startDateTime || !duration) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }
      
      const endDateTime = calculateEndTime(startDateTime, duration);
      
      const activity = {
        id: editingId || Date.now(),
        type,
        name,
        address,
        startDateTime,
        endDateTime,
        duration,
        notes
      };
      
      if (editingId) {
        const index = activities.findIndex(a => a.id === editingId);
        activities[index] = activity;
      } else {
        activities.push(activity);
      }
      
      activities.sort((a, b) => new Date(a.startDateTime) - new Date(b.startDateTime));
      
      saveData();
      renderTimeline();
      closeModal();
    }

    // Delete activity
    function deleteActivity(id) {
      const confirmDelete = true; // Simplified - could add custom modal later
      if (confirmDelete) {
        activities = activities.filter(a => a.id !== id);
        saveData();
        renderTimeline();
      }
    }

    // Group activities by day
    function groupByDay(activitiesToGroup) {
      const grouped = {};
      
      activitiesToGroup.forEach(activity => {
        const date = activity.startDateTime.split('T')[0];
        if (!grouped[date]) {
          grouped[date] = [];
        }
        grouped[date].push(activity);
      });
      

    // Close import modal
    function closeImportModal() {
      document.getElementById('importModal').classList.remove('active');
    }

    // Import data
    function importData() {
      try {
        const jsonText = document.getElementById('importJSON').value;
        const data = JSON.parse(jsonText);
        
        if (data.activities && Array.isArray(data.activities)) {
          activities = data.activities;
          subtitle = data.subtitle || 'Plan Your Perfect Journey';
          document.getElementById('subtitle').textContent = subtitle;
          activities.sort((a, b) => new Date(a.startDateTime) - new Date(b.startDateTime));
          saveData();
          renderTimeline();
          closeImportModal();
          
          // Visual feedback
          showNotification('Trip data imported successfully!', 'success');
        } else {
          showNotification('Invalid JSON format. Please ensure it has an "activities" array.', 'error');
        }
      } catch (error) {
        showNotification('Error parsing JSON: ' + error.message, 'error');
      }
    }

    // Clear all data
    function clearAllData() {
      activities = [];
      subtitle = 'Plan Your Perfect Journey';
      document.getElementById('subtitle').textContent = subtitle;
      saveData();
      renderTimeline();
      toggleMenu();
      showNotification('All activities cleared', 'success');
    }

    // Show notification toast
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Trigger animation
      setTimeout(() => notification.classList.add('show'), 10);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }


</body>
</html>