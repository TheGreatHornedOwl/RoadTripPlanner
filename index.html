<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tom's Road Trip Planner</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Caveat:wght@600&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>ROAD TRIP</h1>
      <div class="tagline" onclick="editSubtitle()" id="subtitle" title="Click to edit">Plan Your Perfect Journey</div>
      <div id="userIndicator" class="user-indicator" style="display: none;">
        <img id="userAvatar" class="user-avatar" src="" alt="">
        <span id="userName"></span>
      </div>
    </header>

    <!-- Map View Button -->
    <div class="map-menu">
      <button class="map-btn" onclick="openMapView()" title="View on Map">
        üó∫Ô∏è
      </button>
    </div>

    <!-- Hamburger Menu -->
    <div class="hamburger-menu">
      <button class="hamburger-btn" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <div class="menu-overlay" onclick="toggleMenu()"></div>
    <div class="menu-panel">
      <!-- User Profile Section -->
      <div class="user-profile-section">
        <div id="loggedOutView">
          <h3 style="font-family: 'Bebas Neue', cursive; font-size: 1.5rem; color: var(--sunset-orange); margin-bottom: 1rem; letter-spacing: 2px;">Account</h3>
          <div id="googleButtonContainer"></div>
        </div>

        <div id="loggedInView" style="display: none;">
          <h3 style="font-family: 'Bebas Neue', cursive; font-size: 1.5rem; color: var(--sunset-orange); margin-bottom: 1rem; letter-spacing: 2px;">Account</h3>
          <div class="user-profile-card">
            <img id="menuUserAvatar" class="user-profile-avatar" src="" alt="">
            <div class="user-profile-name" id="menuUserName"></div>
            <div class="user-profile-email" id="menuUserEmail"></div>
          </div>
          <button class="btn-danger" onclick="logout()" style="width: 100%;">Logout</button>
        </div>
      </div>

      <div class="menu-section">
        <h3>Add Activity</h3>
        <button class="btn-primary" onclick="openAddModal(); toggleMenu();">+ New Activity</button>
      </div>

      <div class="menu-section">
        <h3>Filter</h3>
        <label for="filterDate" style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Select Date:</label>
        <input type="date" id="filterDate" onchange="filterActivities()" style="width: 100%; margin-bottom: 0.8rem;">
        <button class="btn-secondary" onclick="clearFilter()">Show All Days</button>
      </div>

      <div class="menu-section">
        <h3>Tools</h3>
        
        <!-- Google Drive Sync Section -->
        <div class="gdrive-sync-section" id="gdriveSyncSection" style="display: none;">
          <div class="gdrive-sync-title">
            üìÅ Google Drive Sync
          </div>
          <div id="gdriveStatus">
            <span class="gdrive-status disconnected">Not Connected</span>
          </div>
          <div class="gdrive-input-group" id="gdriveSetup">
            <input 
              type="text" 
              id="gdriveFileId" 
              placeholder="Enter Google Drive File ID"
              value="1lxkUvkts9T0fmOPFrFihsPlC_IEOPq5M"
            >
            <div class="gdrive-button-group">
              <button class="btn-secondary" onclick="connectGoogleDrive()">Connect</button>
            </div>
          </div>
          <div class="gdrive-button-group" id="gdriveActions" style="display: none; margin-top: 1rem;">
            <button class="btn-primary" onclick="syncFromGoogleDrive()">
              üîÑ Refresh
            </button>
            <button class="btn-secondary" onclick="saveToGoogleDrive()">
              üíæ Save to Drive
            </button>
            <button class="btn-danger btn-small" onclick="disconnectGoogleDrive()">
              Disconnect
            </button>
          </div>
        </div>
        
        <button class="btn-secondary" onclick="exportData(); toggleMenu();">Export Trip Data</button>
        <button class="btn-secondary" onclick="openImportModal(); toggleMenu();">Import from JSON</button>
        <button class="btn-danger" onclick="clearAllData()">Clear All Activities</button>
      </div>
    </div>

    <div id="timeline" class="timeline"></div>
  </div>

  <!-- Add/Edit Activity Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <h2 id="modalTitle">Add Activity</h2>
      <div id="activityForm">
        <div class="form-group">
          <label for="activityType">Activity Type</label>
          <select id="activityType" required>
            <option value="driving">üöó Driving</option>
            <option value="eating">üçΩÔ∏è Eating</option>
            <option value="sleeping">üõèÔ∏è Sleeping</option>
            <option value="other">üéØ Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="activityName">Activity Name</label>
          <input type="text" id="activityName" placeholder="e.g., Lunch at Joe's Diner" required>
        </div>

        <div class="form-group">
          <label for="address">Address</label>
          <input type="text" id="address" placeholder="e.g., 123 Main St, Springfield, IL" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="startDateTime">Start Date & Time</label>
            <input type="datetime-local" id="startDateTime" required>
          </div>

          <div class="form-group">
            <label for="duration">Duration (hours)</label>
            <input type="number" id="duration" step="0.25" min="0.25" placeholder="e.g., 1.5" required>
          </div>
        </div>

        <div class="form-group">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" placeholder="Any special notes or details..."></textarea>
        </div>

        <div class="button-group">
          <button type="button" class="btn-primary" onclick="saveActivity()">Save Activity</button>
          <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeImportModal()">&times;</button>
      <h2>Import Trip Data</h2>
      <div class="form-group">
        <label for="importJSON">Paste JSON Data</label>
        <textarea id="importJSON" class="json-export" placeholder='{"activities": [...]}'></textarea>
      </div>
      <div class="button-group">
        <button class="btn-primary" onclick="importData()">Import</button>
        <button class="btn-secondary" onclick="closeImportModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeExportModal()">&times;</button>
      <h2>Export Trip Data</h2>
      <div class="form-group">
        <label for="exportJSON">Copy this JSON</label>
        <textarea id="exportJSON" class="json-export" readonly></textarea>
      </div>
      <div class="button-group">
        <button class="btn-primary" onclick="copyToClipboard()">Copy to Clipboard</button>
        <button class="btn-secondary" onclick="downloadJSON()">Download File</button>
        <button class="btn-secondary" onclick="closeExportModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    let activities = [];
    let editingId = null;
    let filterDate = null;
    let subtitle = 'Plan Your Perfect Journey';
    let currentUser = null;
    let googleClientId = '548418558127-oq09sbqgdslma396aukj2alh672qaona.apps.googleusercontent.com';
    let googleDriveFileId = null;
    let googleAccessToken = null;

    // Simple JWT decoder (client-side only)
    function decodeJWT(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (error) {
        console.error('Error decoding JWT:', error);
        return null;
      }
    }

    // Initialize Google Sign-In
    function initGoogleSignIn() {
      // Wait for script to load, with retry mechanism
      let attempts = 0;
      const maxAttempts = 10;
      
      const checkGoogleLoaded = setInterval(() => {
        attempts++;
        
        if (typeof google !== 'undefined' && google.accounts) {
          clearInterval(checkGoogleLoaded);
          
          google.accounts.id.initialize({
            client_id: googleClientId,
            callback: handleGoogleResponse,
            auto_select: false,
            cancel_on_tap_outside: true
          });
          
          // Render the button in the container
          renderGoogleButton();
          
        } else if (attempts >= maxAttempts) {
          clearInterval(checkGoogleLoaded);
          console.warn('Google Identity Services not loaded after multiple attempts.');
          showFallbackMessage();
        }
      }, 300);
    }

    // Render Google Sign-In button
    function renderGoogleButton() {
      const buttonContainer = document.getElementById('googleButtonContainer');
      if (buttonContainer && typeof google !== 'undefined') {
        google.accounts.id.renderButton(
          buttonContainer,
          {
            theme: 'outline',
            size: 'large',
            width: 350,
            text: 'signin_with',
            shape: 'rectangular'
          }
        );
      }
    }

    // Show fallback message
    function showFallbackMessage() {
      const loggedOutView = document.getElementById('loggedOutView');
      if (loggedOutView && !currentUser) {
        loggedOutView.innerHTML = `
          <h3 style="font-family: 'Bebas Neue', cursive; font-size: 1.5rem; color: var(--sunset-orange); margin-bottom: 1rem; letter-spacing: 2px;">Account</h3>
          <div style="padding: 1rem; background: #fff3cd; border-radius: 10px; color: #856404; font-size: 0.9rem; margin-bottom: 1rem;">
            ‚ö†Ô∏è Google Sign-In is blocked by Content Security Policy in Claude artifacts.
          </div>
          <div style="padding: 1rem; background: #d1ecf1; border-radius: 10px; color: #0c5460; font-size: 0.85rem;">
            <strong>üí° Workaround:</strong> Download this HTML file and open it in your browser, or host it on your own domain to enable Google Sign-In.
          </div>
        `;
      }
    }

    // Handle Google Sign-In response
    function handleGoogleResponse(response) {
      const userData = decodeJWT(response.credential);
      if (userData) {
        currentUser = {
          id: userData.sub,
          name: userData.name,
          email: userData.email,
          picture: userData.picture,
          token: response.credential
        };
        
        // Save to localStorage
        localStorage.setItem('roadtripUser', JSON.stringify(currentUser));
        
        updateUIForUser();
        showNotification(`Welcome, ${currentUser.name}!`, 'success');
        
        // Request Google Drive access token with necessary scopes
        setTimeout(() => requestGoogleDriveAccess(), 500);
      }
    }

    // Request Google Drive access with OAuth 2.0
    function requestGoogleDriveAccess() {
      // Show the section immediately
      document.getElementById('gdriveSyncSection').style.display = 'block';
      
      if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
        const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: googleClientId,
          scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
          callback: (tokenResponse) => {
            if (tokenResponse && tokenResponse.access_token) {
              googleAccessToken = tokenResponse.access_token;
              localStorage.setItem('googleAccessToken', googleAccessToken);
              showNotification('Google Drive access granted!', 'success');
            } else if (tokenResponse && tokenResponse.error) {
              showNotification('Drive access denied. You can still use local storage.', 'info');
            }
          },
        });
        tokenClient.requestAccessToken();
      } else {
        // Fallback - show section anyway
        showNotification('Google Drive sync available - connect to enable', 'info');
      }
    }

    // Sign in with Google
    function signInWithGoogle() {
      if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.prompt();
      } else {
        showNotification('Google Sign-In is not available in this environment', 'error');
      }
    }

    // Logout
    function logout() {
      currentUser = null;
      googleAccessToken = null;
      googleDriveFileId = null;
      localStorage.removeItem('roadtripUser');
      localStorage.removeItem('googleAccessToken');
      localStorage.removeItem('googleDriveFileId');
      
      // Revoke Google access
      if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
        google.accounts.id.revoke(currentUser?.email, () => {
          console.log('Access revoked');
        });
      }
      
      updateUIForUser();
      showNotification('Logged out successfully', 'success');
      toggleMenu();
    }

    // Connect to Google Drive file
    function connectGoogleDrive() {
      const fileId = document.getElementById('gdriveFileId').value.trim();
      
      if (!fileId) {
        showNotification('Please enter a File ID', 'error');
        return;
      }
      
      if (!googleAccessToken) {
        showNotification('Please sign in with Google first', 'error');
        requestGoogleDriveAccess();
        return;
      }
      
      googleDriveFileId = fileId;
      localStorage.setItem('googleDriveFileId', fileId);
      
      // Update UI
      document.getElementById('gdriveSetup').style.display = 'none';
      document.getElementById('gdriveActions').style.display = 'flex';
      document.getElementById('gdriveStatus').innerHTML = '<span class="gdrive-status connected">‚úì Connected</span>';
      
      showNotification('Connected to Google Drive', 'success');
      
      // Auto-sync on connect
      syncFromGoogleDrive();
    }

    // Disconnect from Google Drive
    function disconnectGoogleDrive() {
      googleDriveFileId = null;
      localStorage.removeItem('googleDriveFileId');
      
      document.getElementById('gdriveSetup').style.display = 'block';
      document.getElementById('gdriveActions').style.display = 'none';
      document.getElementById('gdriveStatus').innerHTML = '<span class="gdrive-status disconnected">Not Connected</span>';
      
      showNotification('Disconnected from Google Drive', 'info');
    }

    // Sync from Google Drive (Import)
    async function syncFromGoogleDrive() {
      if (!googleAccessToken || !googleDriveFileId) {
        showNotification('Not connected to Google Drive', 'error');
        return;
      }
      
      const refreshBtn = event?.target;
      
      try {
        // Show loading indicator
        if (refreshBtn) {
          refreshBtn.innerHTML = '<span class="refresh-indicator">üîÑ</span> Refreshing...';
          refreshBtn.disabled = true;
        }
        
        const response = await fetch(
          `https://www.googleapis.com/drive/v3/files/${googleDriveFileId}?alt=media`,
          {
            headers: {
              'Authorization': `Bearer ${googleAccessToken}`
            }
          }
        );
        
        if (!response.ok) {
          // Try to parse the error body for helpful messages
          let apiErrorMessage = `HTTP ${response.status}`;
          try {
            const errJson = await response.json();
            console.error('Google Drive API error:', errJson);
            if (errJson && errJson.error && errJson.error.message) {
              apiErrorMessage = `${errJson.error.message} (code: ${errJson.error.code || response.status})`;
            } else if (errJson && errJson.message) {
              apiErrorMessage = `${errJson.message} (code: ${response.status})`;
            }
          } catch (e) {
            console.error('Failed to parse Drive error body:', e);
          }

          if (response.status === 401) {
            // Token expired, request new one
            googleAccessToken = null;
            localStorage.removeItem('googleAccessToken');
            showNotification('Session expired. Please reconnect.', 'error');
            requestGoogleDriveAccess();
            return;
          } else if (response.status === 403) {
            showNotification('Access denied. ' + apiErrorMessage, 'error');
            return;
          }
          throw new Error(apiErrorMessage);
        }
        
        const data = await response.json();
        
        if (data.activities && Array.isArray(data.activities)) {
          activities = data.activities;
          subtitle = data.subtitle || 'Plan Your Perfect Journey';
          document.getElementById('subtitle').textContent = subtitle;
          activities.sort((a, b) => new Date(a.startDateTime) - new Date(b.startDateTime));
          saveData();
          renderTimeline();
          showNotification('‚úì Synced from Google Drive', 'success');
        } else {
          throw new Error('Invalid JSON format');
        }
      } catch (error) {
        console.error('Error syncing from Google Drive:', error);
        showNotification('Failed to sync from Google Drive: ' + error.message, 'error');
      } finally {
        // Reset button
        if (refreshBtn) {
          refreshBtn.innerHTML = 'üîÑ Refresh';
          refreshBtn.disabled = false;
        }
      }
    }

    // Save to Google Drive (Export)
    async function saveToGoogleDrive() {
      if (!googleAccessToken || !googleDriveFileId) {
        showNotification('Not connected to Google Drive', 'error');
        return;
      }
      
      const saveBtn = event?.target;
      
      try {
        const data = {
          subtitle: subtitle,
          activities: activities
        };
        
        if (saveBtn) {
          saveBtn.innerHTML = 'üíæ Saving...';
          saveBtn.disabled = true;
        }
        
        const response = await fetch(
          `https://www.googleapis.com/upload/drive/v3/files/${googleDriveFileId}?uploadType=media`,
          {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${googleAccessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data, null, 2)
          }
        );
        
        if (!response.ok) {
          // Parse error body to surface meaningful API messages
          let apiErrorMessage = `HTTP ${response.status}`;
          try {
            const errJson = await response.json();
            console.error('Google Drive API error:', errJson);
            if (errJson && errJson.error && errJson.error.message) {
              apiErrorMessage = `${errJson.error.message} (code: ${errJson.error.code || response.status})`;
            } else if (errJson && errJson.message) {
              apiErrorMessage = `${errJson.message} (code: ${response.status})`;
            }
          } catch (e) {
            console.error('Failed to parse Drive error body:', e);
          }

          if (response.status === 401) {
            googleAccessToken = null;
            localStorage.removeItem('googleAccessToken');
            showNotification('Session expired. Please reconnect.', 'error');
            requestGoogleDriveAccess();
            return;
          } else if (response.status === 403) {
            showNotification('Access denied. ' + apiErrorMessage, 'error');
            return;
          }
          throw new Error(apiErrorMessage);
        }
        
        showNotification('‚úì Saved to Google Drive', 'success');
      } catch (error) {
        console.error('Error saving to Google Drive:', error);
        showNotification('Failed to save to Google Drive: ' + error.message, 'error');
      } finally {
        if (saveBtn) {
          saveBtn.innerHTML = 'üíæ Save to Drive';
          saveBtn.disabled = false;
        }
      }
    }

    // Debug helper: check access token and fetch file metadata to diagnose permission errors
    async function debugDriveAccess() {
      if (!googleAccessToken || !googleDriveFileId) {
        showNotification('Sign in and enter a File ID first', 'error');
        console.warn('Missing googleAccessToken or googleDriveFileId', { googleAccessToken, googleDriveFileId });
        return;
      }

      showNotification('Debugging Google Drive access (see console)...', 'info');

      try {
        // 1) Token info
        try {
          const tokenInfoResp = await fetch(`https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=${encodeURIComponent(googleAccessToken)}`);
          const tokenInfo = await tokenInfoResp.json();
          console.group('Google Access Token Info');
          console.log('tokeninfo status:', tokenInfoResp.status);
          console.log(tokenInfo);
          console.groupEnd();
        } catch (e) {
          console.error('Failed to fetch token info:', e);
        }

        // 2) File metadata
        const metaResp = await fetch(
          `https://www.googleapis.com/drive/v3/files/${googleDriveFileId}?fields=id,name,mimeType,owners,permissions,sharingUser`,
          {
            headers: {
              'Authorization': `Bearer ${googleAccessToken}`
            }
          }
        );

        let metaBody;
        try {
          metaBody = await metaResp.json();
        } catch (e) {
          metaBody = await metaResp.text();
        }

        console.group('Drive File Metadata Response');
        console.log('status:', metaResp.status);
        console.log(metaBody);
        console.groupEnd();

        if (!metaResp.ok) {
          // If we got a JSON error, show it
          const msg = (metaBody && metaBody.error && metaBody.error.message) ? metaBody.error.message : `HTTP ${metaResp.status}`;
          showNotification('Drive metadata fetch failed: ' + msg, 'error');
          // Helpful hint for common issues
          if (metaResp.status === 403) {
            console.warn('403 Forbidden - possible causes: file not shared with this account, token lacks proper Drive scopes, or file is a Google Docs native mimeType requiring export.');
          }
          return;
        }

        showNotification('Drive metadata retrieved ‚Äî check console for details', 'success');

        // If this is a native Google Docs type, we cannot GET alt=media; must use files/export
        if (metaBody && metaBody.mimeType && metaBody.mimeType.startsWith('application/vnd.google-apps')) {
          console.warn('File is a native Google Workspace file (e.g., Google Docs/Sheets). Use the Drive export endpoint to download content.');
          showNotification('File is a Google Docs type ‚Äî use export API (see console)', 'info');
        }
      } catch (error) {
        console.error('Error debugging Drive access:', error);
        showNotification('Debug failed: ' + error.message, 'error');
      }
    }

    // Update UI based on user state
    function updateUIForUser() {
      const loggedInView = document.getElementById('loggedInView');
      const loggedOutView = document.getElementById('loggedOutView');
      const userIndicator = document.getElementById('userIndicator');
      const gdriveSyncSection = document.getElementById('gdriveSyncSection');
      
      if (currentUser) {
        // Show logged in view
        loggedInView.style.display = 'block';
        loggedOutView.style.display = 'none';
        
        // Update menu profile
        document.getElementById('menuUserAvatar').src = currentUser.picture;
        document.getElementById('menuUserName').textContent = currentUser.name;
        document.getElementById('menuUserEmail').textContent = currentUser.email;
        
        // Update header indicator
        userIndicator.style.display = 'flex';
        document.getElementById('userAvatar').src = currentUser.picture;
        document.getElementById('userName').textContent = currentUser.name;
        
        // Always show Google Drive section when logged in
        gdriveSyncSection.style.display = 'block';
        
        // If file ID is saved, show connected state
        if (googleDriveFileId) {
          document.getElementById('gdriveSetup').style.display = 'none';
          document.getElementById('gdriveActions').style.display = 'flex';
          document.getElementById('gdriveStatus').innerHTML = '<span class="gdrive-status connected">‚úì Connected</span>';
        }
      } else {
        // Show logged out view
        loggedInView.style.display = 'none';
        loggedOutView.style.display = 'block';
        userIndicator.style.display = 'none';
        gdriveSyncSection.style.display = 'none';
      }
    }

    // Load user from localStorage
    function loadUser() {
      const savedUser = localStorage.getItem('roadtripUser');
      const savedToken = localStorage.getItem('googleAccessToken');
      const savedFileId = localStorage.getItem('googleDriveFileId');
      
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          googleAccessToken = savedToken;
          googleDriveFileId = savedFileId;
          updateUIForUser();
        } catch (error) {
          console.error('Error loading user:', error);
          localStorage.removeItem('roadtripUser');
          localStorage.removeItem('googleAccessToken');
          localStorage.removeItem('googleDriveFileId');
        }
      }
    }

    // Toggle hamburger menu
    function toggleMenu() {
      const btn = document.querySelector('.hamburger-btn');
      const panel = document.querySelector('.menu-panel');
      const overlay = document.querySelector('.menu-overlay');
      
      btn.classList.toggle('active');
      panel.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // Load data from localStorage on startup
    function loadData() {
      const saved = localStorage.getItem('roadtripActivities');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          // Support both old format (just array) and new format (object with subtitle)
          if (Array.isArray(data)) {
            activities = data;
          } else {
            activities = data.activities || [];
            subtitle = data.subtitle || 'Plan Your Perfect Journey';
            document.getElementById('subtitle').textContent = subtitle;
          }
        } catch (e) {
          activities = [];
        }
      }
      renderTimeline();
    }

    // Save data to localStorage
    function saveData() {
      const data = {
        subtitle: subtitle,
        activities: activities
      };
      localStorage.setItem('roadtripActivities', JSON.stringify(data));
    }

    // Edit subtitle
    function editSubtitle() {
      const subtitleEl = document.getElementById('subtitle');
      const currentText = subtitleEl.textContent;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentText;
      input.style.cssText = `
        font-family: 'Caveat', cursive;
        font-size: 1.8rem;
        color: var(--road-gray);
        border: 3px solid var(--sunset-orange);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        background: white;
        text-align: center;
        width: 400px;
        max-width: 90vw;
      `;
      
      input.onblur = function() {
        const newText = input.value.trim() || 'Plan Your Perfect Journey';
        subtitle = newText;
        subtitleEl.textContent = newText;
        saveData();
      };
      
      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          input.blur();
        } else if (e.key === 'Escape') {
          subtitleEl.textContent = currentText;
        }
      };
      
      subtitleEl.textContent = '';
      subtitleEl.appendChild(input);
      input.focus();
      input.select();
    }

    // Calculate end time based on start time and duration
    function calculateEndTime(startDateTime, durationHours) {
      const start = new Date(startDateTime);
      const end = new Date(start.getTime() + durationHours * 60 * 60 * 1000);
      // Return in local datetime format (YYYY-MM-DDTHH:mm)
      const year = end.getFullYear();
      const month = String(end.getMonth() + 1).padStart(2, '0');
      const day = String(end.getDate()).padStart(2, '0');
      const hours = String(end.getHours()).padStart(2, '0');
      const minutes = String(end.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Format date for display - Fixed to use local date string parsing
    function formatDate(dateString) {
      // Parse as local date to avoid timezone issues
      const [year, month, day] = dateString.split('-');
      const date = new Date(year, month - 1, day);
      return date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }

    // Format time for display
    function formatTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
    }

    // Get Google Maps directions URL
    function getDirectionsUrl(address) {
      const encodedAddress = encodeURIComponent(address);
      return `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
    }

    // Open map view with all activities
    function openMapView() {
      let activitiesToMap = activities;
      
      // If filtered, only show filtered activities
      if (filterDate) {
        activitiesToMap = activities.filter(a => a.startDateTime.startsWith(filterDate));
      }
      
      if (activitiesToMap.length === 0) {
        showNotification('No activities to show on map', 'error');
        return;
      }
      
      // Build Google Maps URL with directions
      // Google Maps supports up to 10 waypoints, so we'll use the first 10 activities
      const maxWaypoints = 9; // origin + 9 waypoints + destination = 11 total stops
      const limitedActivities = activitiesToMap.slice(0, maxWaypoints + 1);
      
      let mapUrl = 'https://www.google.com/maps/dir/?api=1';
      
      // Set origin (first activity)
      const origin = encodeURIComponent(limitedActivities[0].address);
      mapUrl += `&origin=${origin}`;
      
      // Set destination (last activity in our limited set)
      const destination = encodeURIComponent(limitedActivities[limitedActivities.length - 1].address);
      mapUrl += `&destination=${destination}`;
      
      // Set waypoints (middle activities)
      if (limitedActivities.length > 2) {
        const waypoints = limitedActivities.slice(1, -1).map(a => encodeURIComponent(a.address)).join('|');
        mapUrl += `&waypoints=${waypoints}`;
      }
      
      // Open in new tab
      window.open(mapUrl, '_blank');
      
      // Show notification if we had to limit activities
      if (activitiesToMap.length > maxWaypoints + 1) {
        showNotification(`Showing first ${maxWaypoints + 1} activities on map (Google Maps limit)`, 'info');
      }
    }

    // Open add modal
    function openAddModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Add Activity';
      // Reset all form fields
      document.getElementById('activityType').value = 'driving';
      document.getElementById('activityName').value = '';
      document.getElementById('address').value = '';
      document.getElementById('duration').value = '';
      document.getElementById('notes').value = '';
      
      // Set start time to last activity's end time, or current time if no activities
      let defaultStartTime;
      if (activities.length > 0) {
        // Get the last activity (already sorted)
        const lastActivity = activities[activities.length - 1];
        defaultStartTime = lastActivity.endDateTime;
      } else {
        // No activities yet, use current time rounded to nearest 15 minutes
        const now = new Date();
        now.setMinutes(Math.round(now.getMinutes() / 15) * 15);
        now.setSeconds(0);
        now.setMilliseconds(0);
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        defaultStartTime = `${year}-${month}-${day}T${hours}:${minutes}`;
      }
      
      document.getElementById('startDateTime').value = defaultStartTime;
      document.getElementById('activityModal').classList.add('active');
    }

    // Open edit modal
    function openEditModal(id) {
      editingId = id;
      const activity = activities.find(a => a.id === id);
      
      document.getElementById('modalTitle').textContent = 'Edit Activity';
      document.getElementById('activityType').value = activity.type;
      document.getElementById('activityName').value = activity.name;
      document.getElementById('address').value = activity.address;
      document.getElementById('startDateTime').value = activity.startDateTime;
      document.getElementById('duration').value = activity.duration;
      document.getElementById('notes').value = activity.notes || '';
      
      document.getElementById('activityModal').classList.add('active');
    }

    // Close modal
    function closeModal() {
      document.getElementById('activityModal').classList.remove('active');
      editingId = null;
    }

    // Save activity - FIXED
    function saveActivity() {
      const type = document.getElementById('activityType').value;
      const name = document.getElementById('activityName').value;
      const address = document.getElementById('address').value;
      const startDateTime = document.getElementById('startDateTime').value;
      const duration = parseFloat(document.getElementById('duration').value);
      const notes = document.getElementById('notes').value;
      
      // Validate required fields
      if (!name || !address || !startDateTime || !duration) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }
      
      const endDateTime = calculateEndTime(startDateTime, duration);
      
      const activity = {
        id: editingId || Date.now(),
        type,
        name,
        address,
        startDateTime,
        endDateTime,
        duration,
        notes
      };
      
      if (editingId) {
        const index = activities.findIndex(a => a.id === editingId);
        activities[index] = activity;
      } else {
        activities.push(activity);
      }
      
      activities.sort((a, b) => new Date(a.startDateTime) - new Date(b.startDateTime));
      
      saveData();
      renderTimeline();
      closeModal();
    }

    // Delete activity
    function deleteActivity(id) {
      const confirmDelete = true; // Simplified - could add custom modal later
      if (confirmDelete) {
        activities = activities.filter(a => a.id !== id);
        saveData();
        renderTimeline();
      }
    }

    // Group activities by day
    function groupByDay(activitiesToGroup) {
      const grouped = {};
      
      activitiesToGroup.forEach(activity => {
        const date = activity.startDateTime.split('T')[0];
        if (!grouped[date]) {
          grouped[date] = [];
        }
        grouped[date].push(activity);
      });
      
      return grouped;
    }

    // Render timeline
    function renderTimeline() {
      const timeline = document.getElementById('timeline');
      
      let activitiesToRender = activities;
      if (filterDate) {
        activitiesToRender = activities.filter(a => a.startDateTime.startsWith(filterDate));
      }
      
      if (activitiesToRender.length === 0) {
        timeline.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üó∫Ô∏è</div>
            <h3>No Activities Yet</h3>
            <p>Start planning your adventure by adding your first activity!</p>
          </div>
        `;
        return;
      }
      
      const groupedActivities = groupByDay(activitiesToRender);
      
      let html = '';
      Object.keys(groupedActivities).sort().forEach((date, dayIndex) => {
        const dayActivities = groupedActivities[date];
        
        html += `
          <div class="day-section" style="animation-delay: ${dayIndex * 0.1}s">
            <div class="day-header">${formatDate(date)}</div>
        `;
        
        dayActivities.forEach((activity, actIndex) => {
          const typeEmoji = {
            driving: 'üöó',
            eating: 'üçΩÔ∏è',
            sleeping: 'üõèÔ∏è',
            other: 'üéØ'
          };
          
          html += `
            <div class="activity-card ${activity.type}" style="animation-delay: ${(dayIndex * 0.1) + (actIndex * 0.05)}s">
              <div class="activity-header">
                <div class="activity-title">${typeEmoji[activity.type]} ${activity.name}</div>
                <div class="activity-type ${activity.type}">${activity.type}</div>
              </div>
              
              <div class="activity-time">
                ${formatTime(activity.startDateTime)} 
                <span class="time-arrow">‚Üí</span> 
                ${formatTime(activity.endDateTime)}
                <span style="color: var(--desert-sand); margin-left: 1rem;">(${activity.duration} hrs)</span>
              </div>
              
              <div class="activity-details">
                <a href="${getDirectionsUrl(activity.address)}" 
                   target="_blank" 
                   class="address-link">
                  üìç ${activity.address}
                </a>
                ${activity.notes ? `<p style="margin-top: 1rem;"><strong>Notes:</strong> ${activity.notes}</p>` : ''}
              </div>
              
              <div class="activity-actions">
                <button class="btn-secondary btn-small" onclick="openEditModal(${activity.id})">
                  Edit
                </button>
                <button class="btn-danger btn-small" onclick="deleteActivity(${activity.id})">
                  Delete
                </button>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      timeline.innerHTML = html;
    }

    // Filter activities
    function filterActivities() {
      filterDate = document.getElementById('filterDate').value;
      renderTimeline();
    }

    // Clear filter
    function clearFilter() {
      filterDate = null;
      document.getElementById('filterDate').value = '';
      renderTimeline();
    }

    // Export data
    function exportData() {
      const data = JSON.stringify({ subtitle, activities }, null, 2);
      document.getElementById('exportJSON').value = data;
      document.getElementById('exportModal').classList.add('active');
    }

    // Close export modal
    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('active');
    }

    // Copy to clipboard
    function copyToClipboard() {
      const textarea = document.getElementById('exportJSON');
      textarea.select();
      document.execCommand('copy');
      
      // Visual feedback instead of alert
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚úì Copied!';
      btn.style.background = 'linear-gradient(135deg, var(--map-green), var(--sky-blue))';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    }

    // Download JSON file
    function downloadJSON() {
      const data = document.getElementById('exportJSON').value;
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `roadtrip-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Open import modal
    function openImportModal() {
      document.getElementById('importJSON').value = '';
      document.getElementById('importModal').classList.add('active');
    }

    // Close import modal
    function closeImportModal() {
      document.getElementById('importModal').classList.remove('active');
    }

    // Import data
    function importData() {
      try {
        const jsonText = document.getElementById('importJSON').value;
        const data = JSON.parse(jsonText);
        
        if (data.activities && Array.isArray(data.activities)) {
          activities = data.activities;
          subtitle = data.subtitle || 'Plan Your Perfect Journey';
          document.getElementById('subtitle').textContent = subtitle;
          activities.sort((a, b) => new Date(a.startDateTime) - new Date(b.startDateTime));
          saveData();
          renderTimeline();
          closeImportModal();
          
          // Visual feedback
          showNotification('Trip data imported successfully!', 'success');
        } else {
          showNotification('Invalid JSON format. Please ensure it has an "activities" array.', 'error');
        }
      } catch (error) {
        showNotification('Error parsing JSON: ' + error.message, 'error');
      }
    }

    // Clear all data
    function clearAllData() {
      activities = [];
      subtitle = 'Plan Your Perfect Journey';
      document.getElementById('subtitle').textContent = subtitle;
      saveData();
      renderTimeline();
      toggleMenu();
      showNotification('All activities cleared', 'success');
    }

    // Show notification toast
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Trigger animation
      setTimeout(() => notification.classList.add('show'), 10);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Initialize
    loadUser();
    initGoogleSignIn();
    loadData();
  </script>
</body>
</html>